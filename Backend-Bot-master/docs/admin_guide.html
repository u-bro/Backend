<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Service — Руководство по Django‑админке</title>
  <style>
    body{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111}
    h1,h2,h3{color:#0b63a3}
    pre{background:#f6f8fa;padding:12px;border-radius:6px;overflow:auto}
    .kbd{background:#eef;padding:2px 6px;border-radius:4px;border:1px solid #cce}
    section{margin-bottom:18px}
    ul{margin:6px 0 12px 20px}
    code{background:#f3f4f6;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <h1>Admin Service — Руководство по Django‑админке</h1>
  <p>Полный гайд по разделам, ролям, функциям и приёмке админ‑панели (составлен по заданию).</p>

  <section>
    <h2>Краткое описание</h2>
    <p>Данное руководство описывает поведение и проверки для административного сервиса, реализованного в проекте в папке <code>admin_service</code>. Оно покрывает роли, права, основные разделы меню, сценарии в браузере и критерии приёмки.</p>
  </section>

  <section>
    <h2>Роли и права</h2>
    <p>Две основные роли: <strong>Admin</strong> и <strong>Operator</strong>.</p>
    <ul>
      <li><strong>Admin</strong>: полный доступ ко всем разделам, настройкам, аудит‑логам и управлению ролями.</li>
      <li><strong>Operator</strong>: операционная работа (заказы, назначение водителей, модерация); нет доступа к системным конфигам, ключам интеграций и журналу секретов.</li>
    </ul>
  </section>

  <section>
    <h2>Структура меню (верхнего уровня)</h2>
    <ol>
      <li>Дашборд</li>
      <li>Заказы</li>
      <li>Платежи и чеки</li>
      <li>Пользователи (Клиенты / Водители)</li>
      <li>Назначения (операции)</li>
      <li>Отзывы и рейтинг</li>
      <li>Аналитика</li>
      <li>Справочники</li>
      <li>Тарифы и комиссия</li>
      <li>Уведомления и шаблоны</li>
      <li>Настройки</li>
      <li>Журналы и аудит</li>
    </ol>
  </section>

  <section>
    <h2>Что тестировать в браузере (пошаговый чек‑лист)</h2>
    <h3>Подготовка</h3>
    <pre>cd admin_service
python manage.py migrate
python manage.py createsuperuser
python manage.py runserver 0.0.0.0:8000
# открыть http://localhost:8000/admin/</pre>

    <h3>Чек‑пункты</h3>
    <ol>
      <li>Войти как <code>Admin</code> — убедиться, что видны все разделы и справочники.</li>
      <li>Проверить группы: открыть <code>Groups</code> и убедиться, что есть <code>Admin</code> и <code>Operator</code>.</li>
      <li>Пользователи (Clients):
        <ul>
          <li>Открыть карточку клиента — проверить контакты, историю заказов, платежей.</li>
          <li>Выполнить блокировку/разблокировку: у <code>Operator</code> поле «причина» должно быть обязательным (если не реализовано — пометить как баг).</li>
          <li>Проверить, что действие записывается в <code>AdminAuditLog</code> (actor, reason, old/new values).</li>
        </ul>
      </li>
      <li>Водители:
        <ul>
          <li>Создать профиль водителя (Operator и Admin) и загрузить документы.</li>
          <li>Подтвердить/отклонить документы с указанием причины; проверить запись в аудит.</li>
          <li>Перевести водителя в Elite (если авто соответствует) — проверить историю изменений.</li>
        </ul>
      </li>
      <li>Заказы:
        <ul>
          <li>Открыть список — применить фильтры по статусу, дате, классу, флагам ANOMALY.</li>
          <li>Открыть карточку заказа — проверить таймлайн, блок «Назначение», коммуникации.</li>
          <li>Выполнить отмену заказа с указанием причины; проверить сохранение причины и запись в аудит.</li>
          <li>Переопубликовать/переназначить — проверить подбор водителей (допуски/ETA) и лог операции.</li>
        </ul>
      </li>
      <li>Платежи и рефанды:
        <ul>
          <li>Открыть платёж — проверить статусы, историю вебхуков, idempotency key и ссылки на чек.</li>
          <li>Если интерфейс рефандов есть — инициировать частичный/полный рефанд с обязательной причиной; проверить политику и запись в аудит.</li>
        </ul>
      </li>
      <li>Тарифы/комиссии:
        <ul>
          <li>Как Admin — создать/изменить тариф; убедиться, что создаётся новая версия (tariff_version) и запись в аудит.</li>
          <li>Как Operator — попытаться изменить тариф (ожидается запрет).</li>
        </ul>
      </li>
      <li>Дашборд:
        <ul>
          <li>Проверить KPI карточки и тревоги; клик по KPI открывает соответствующий список фильтрованых заказов.</li>
        </ul>
      </li>
      <li>Аудит:
        <ul>
          <li>Открыть <code>AdminAuditLog</code> и убедиться, что ключевые операции (assign, cancel, block, tariff change, refund) записаны с полями: actor_id, action, target_type, target_id, old_values, new_values, reason.</li>
        </ul>
      </li>
    </ol>
  </section>

  <section>
    <h2>Требования UX и безопасности</h2>
    <ul>
      <li>Поиск по id/телефону/номеру заказа на всех списковых экранах.</li>
      <li>Предпросмотр фото документов; маски телефонов/документов.</li>
      <li>Подтверждающие модалки для опасных действий (cancel, refund, ban).</li>
      <li>Хранение секретов и интеграционных ключей вне админки в секретном хранилище.</li>
    </ul>
  </section>

  <section>
    <h2>Критерии приёмки (основные)</h2>
    <ul>
      <li>Operator может создавать карточки водителя, загружать документы, отправлять на модерацию и назначать/переназначать водителя в рамках регламента.</li>
      <li>Изменение тарифа возможно только через создание новой версии и запись в аудит.</li>
      <li>Любое назначение/переназначение фиксируется в логах с actor_id и reason.</li>
      <li>PDF‑чеки и квитанции доступны для скачивания и повторная отправка логируется.</li>
    </ul>
  </section>

  <section>
    <h2>Развёртывание / тестирование</h2>
    <pre>docker compose up -d --build
docker exec -it WEB_APP alembic upgrade head
pytest tests_live/ -v</pre>
    <p>HTML coverage формируется в <code>htmlcov/index.html</code>.</p>
  </section>

  <section>
    <h2>Список известных GAP/рекомендаций</h2>
    <ol>
      <li>Убрать хардкод паролей и не печатать их в логах.</li>
      <li>Убедиться, что все критичные actions пишут запись в аудит.</li>
      <li>Реализовать обязательное поле "reason" для операций Operator (ban, cancel, refund).</li>
      <li>Унифицировать `api_client` (HTTP-клиент) или явно разделить ORM‑хелперы.</li>
      <li>Добавить интеграционные тесты для админки в CI.</li>
    </ol>
  </section>

  <footer>
    <p>Файл положен в <code>docs/admin_guide.html</code>.</p>
  </footer>
</body>
</html>
