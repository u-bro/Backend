Задачи — WebSocket (временный контрольный файл)

Цель:
- Полностью документировать и протестировать WebSocket-функционал сервиса так, чтобы любой инженер мог понять поведение, форматы сообщений и выполнить E2E-проверки без изменения кода.

Принципы:
- Код не меняется без явного разрешения владельца.
- Все тесты выполняются по шагам; тела запросов фиксируются в этом файле.

Шаблон входных данных (заполните перед стартом):
- SERVER_BASE: http://localhost:5000
- API_PREFIX: /api/v1
- Терминал: wsl | powershell  (укажите)
- Admin creds: email / password  (укажите или дайте команду для получения токена)
- Test user (client) creds: email / password
- Test driver user creds: email / password
- Ride ID для тестов: <ride_id>
- Driver user_id: <driver_user_id>
- Client user_id: <client_user_id>
- Разрешение на временные DB-вставки: да | нет

Порядок работ (выполнять по очереди):
1) Проверка доступности
   - Ожидаем: Swagger UI по `SERVER_BASE` + `API_PREFIX` (например `http://localhost:5000/docs`).
   - Команда для проверки:
     curl -sI {SERVER_BASE}{API_PREFIX}/openapi.json

2) Аутентификация
   - Получить access token для admin и тестовых пользователей.
   - Пример:
     POST {SERVER_BASE}{API_PREFIX}/auth/login
     body: {"phone": "+70123456789", "password":"P@ssw0rd"}
   - Ожидаемый ответ: {"access_token":"...","user_id":123}

3) Подключение к WebSocket
   - URL: ws://{HOST}{API_PREFIX}/ws/{user_id}?token={access_token}
   - Примеры клиентов: браузер (Console), `wscat`, `websocat`, Node.js (`ws`) или Python (`websockets`)

4) Базовые сообщения и форматы (точно копировать):
   - Ping:
     {"type":"ping"}
   - Join ride:
     {"type":"join_ride","ride_id":<ride_id>}
   - Chat message (client -> server):
     {"type":"chat_message","ride_id":<ride_id>,"text":"...","receiver_id":<user_id_or_null>}
   - Location update (driver -> server):
     {"type":"location_update","ride_id":<ride_id>,"latitude":55.7,"longitude":37.6,"heading":90.0,"speed":10.5}

5) Проверка рассылки и логики ride rooms
   - Подключить 2 клиента: driver и client. Оба выполнить `join_ride`.
   - Отправить `chat_message` от клиента — ожидать получение у driver (и наоборот).

6) Сохранение сообщений в БД
   - Текущее состояние: WS `handle_chat_message` рассылает сообщения, но не сохраняет в БД автоматически.
   - Альтернатива (без изменений кода): создавать сообщение через REST API `POST {API_PREFIX}/chat-messages` с тем же телом, что и WS.
   - Пример REST create:
     POST {SERVER_BASE}{API_PREFIX}/chat-messages
     body: {"ride_id":<ride_id>,"text":"...","sender_id":<user_id>,"receiver_id":<user_id>}

7) Стресс/модерация/лимиты
   - Тесты на превышение лимита сообщений (10 per 60s) и на profanity.

8) HTTP-хелперы WebSocket
   - Проверить:
     POST {API_PREFIX}/ws/driver/{user_id}/location  (body: latitude, longitude,...)
     GET  {API_PREFIX}/ws/driver/{user_id}/state
     POST {API_PREFIX}/ws/notify/{user_id}
     POST {API_PREFIX}/ws/broadcast

9) Политика доступа к просмотру чата (заполнить, согласовать)
   - Просмотр разрешён, если: пользователь == rides.client_id OR пользователь == driver assigned to ride OR роль == admin.
   - Тест: попробовать получить историю `/chat-messages?ride_id=<ride_id>` под каждым пользователем и зафиксировать ответы.

10) Сбор результатов
   - Сохранять выводы команд и ответы в `tests/ws_results/` (создавать файлы: connectivity.txt, tokens.txt, ws_flow.log, http_helpers.txt)

Acceptance criteria:
- Можно воспроизвести подключение WS и выполнить сценарий chat+location+join_ride.
- Форматы тел запросов и ожидаемые ответы задокументированы в этом файле и в итоговом HTML.
- Сохранение истории доступно через REST (и отмечено, что WS пока не персистит).

Что я не буду делать без OK:
- Изменять код проекта (включая авто-сохранение WS в БД).
- Писать миграции или вставлять записи в БД без согласования.

Шаблон отчёта по шагу (копировать и заполнять при выполнении):
- Шаг #: <описание шага>
- Команда:
  <curl/wscat/команда>
- Ответ сервера (сократить/привести ключевые поля):
  <ответ>
- Статус: OK | FAIL
- Примечания/ошибки:
  <текст>

Checklist (связь с todo ids):
- [ ] Подготовить окружение (todo:1)
- [ ] Собрать вводные данные (todo:2)
- [ ] Документация WebSocket (todo:3)
- [ ] Политика доступа к чату (todo:4)
- [ ] Схемы сообщений (todo:5)
- [ ] Тест-кейсы (todo:6)
- [ ] Проверить хранение чата (todo:7)
- [ ] Сбор логов (todo:8)
- [ ] Финализация (todo:9)

Заполните шаблон входных данных выше и напишите «старт», когда будете готовы, я начну выполнять шаги и заполнять отчёт прямо в `tests/ws_results/`.
